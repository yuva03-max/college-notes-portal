{% extends "base.html" %}

{% block title %}{{ note.title }} - Viewer{% endblock %}

{% block extra_css %}
<style>
    .viewer-container {
        background: var(--card-bg);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow);
    }
    .viewer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
        gap: 10px;
    }
    .viewer-title {
        font-size: 1.2rem;
        font-weight: 600;
    }
    .viewer-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .viewer-content {
        min-height: 70vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: var(--body-bg);
        position: relative;
    }
    .pdf-container {
        width: 100%;
        height: 80vh;
    }
    .pdf-container iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    .image-viewer {
        max-width: 100%;
        max-height: 80vh;
        object-fit: contain;
    }
    .video-viewer, .audio-viewer {
        max-width: 100%;
        width: 100%;
    }
    .text-viewer {
        width: 100%;
        padding: 20px;
        background: var(--card-bg);
        overflow: auto;
        max-height: 80vh;
    }
    .text-viewer pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }
    .unsupported {
        text-align: center;
        padding: 60px;
    }
    .unsupported i {
        font-size: 60px;
        color: var(--gray-color);
        margin-bottom: 20px;
    }
    .zoom-controls {
        display: flex;
        gap: 5px;
        align-items: center;
    }
    .zoom-controls button {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .zoom-controls button:hover {
        background: var(--border-color);
    }
    #zoomLevel {
        min-width: 50px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="viewer-container">
    <div class="viewer-header">
        <div class="viewer-title">
            <i class="fas fa-file"></i> {{ note.title }}
        </div>
        <div class="viewer-controls">
            {% if note.file_type in ['pdf', 'image'] %}
            <div class="zoom-controls">
                <button onclick="zoomOut()" title="Zoom Out"><i class="fas fa-minus"></i></button>
                <span id="zoomLevel">100%</span>
                <button onclick="zoomIn()" title="Zoom In"><i class="fas fa-plus"></i></button>
                <button onclick="resetZoom()" title="Reset"><i class="fas fa-undo"></i></button>
            </div>
            {% endif %}
            <button class="btn btn-secondary btn-sm" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i> Fullscreen
            </button>
            <a href="{{ url_for('download_note', note_id=note.id) }}" class="btn btn-primary btn-sm">
                <i class="fas fa-download"></i> Download
            </a>
            <a href="{{ url_for('list_notes') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>
    
    <div class="viewer-content" id="viewerContent">
        {% if note.file_type == 'pdf' %}
        <div class="pdf-container">
            <iframe src="{{ url_for('serve_file', filename=note.filename) }}" id="pdfFrame"></iframe>
        </div>
        
        {% elif note.file_type == 'image' %}
        <img src="{{ url_for('serve_file', filename=note.filename) }}" alt="{{ note.title }}" class="image-viewer" id="imageViewer">
        
        {% elif note.file_type == 'video' %}
        <video controls class="video-viewer">
            <source src="{{ url_for('serve_file', filename=note.filename) }}">
            Your browser does not support video playback.
        </video>
        
        {% elif note.file_type == 'audio' %}
        <audio controls class="audio-viewer">
            <source src="{{ url_for('serve_file', filename=note.filename) }}">
            Your browser does not support audio playback.
        </audio>
        
        {% elif note.file_type == 'text' %}
        <div class="text-viewer">
            <pre id="textContent">Loading...</pre>
        </div>
        
        {% else %}
        <div class="unsupported">
            <i class="fas fa-file-alt"></i>
            <h3>Preview not available</h3>
            <p>This file type cannot be previewed in the browser.</p>
            <a href="{{ url_for('download_note', note_id=note.id) }}" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-download"></i> Download File
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentZoom = 100;
    
    function zoomIn() {
        currentZoom = Math.min(currentZoom + 25, 300);
        applyZoom();
    }
    
    function zoomOut() {
        currentZoom = Math.max(currentZoom - 25, 25);
        applyZoom();
    }
    
    function resetZoom() {
        currentZoom = 100;
        applyZoom();
    }
    
    function applyZoom() {
        document.getElementById('zoomLevel').textContent = currentZoom + '%';
        const img = document.getElementById('imageViewer');
        if (img) {
            img.style.transform = `scale(${currentZoom / 100})`;
        }
    }
    
    function toggleFullscreen() {
        const elem = document.getElementById('viewerContent');
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            elem.requestFullscreen();
        }
    }
    
    {% if note.file_type == 'text' %}
    fetch('{{ url_for("serve_file", filename=note.filename) }}')
        .then(response => response.text())
        .then(text => {
            document.getElementById('textContent').textContent = text;
        })
        .catch(err => {
            document.getElementById('textContent').textContent = 'Error loading file.';
        });
    {% endif %}
</script>
{% endblock %}
