{% extends "base.html" %}

{% block title %}AI Study Assistant - College Notes Portal{% endblock %}

{% block extra_css %}
<style>
    .ai-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }

    @media (max-width: 900px) {
        .ai-container {
            grid-template-columns: 1fr;
        }
    }

    .ai-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 25px;
        box-shadow: var(--shadow);
    }

    .ai-card h3 {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .ai-card h3 i {
        color: var(--primary-color);
    }

    .chat-box {
        height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: var(--body-bg);
    }

    .chat-message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 12px;
        max-width: 85%;
    }

    .chat-message.user {
        background: var(--primary-color);
        color: white;
        margin-left: auto;
    }

    .chat-message.ai {
        background: var(--light-color);
        color: var(--text-color);
    }

    .input-group {
        display: flex;
        gap: 10px;
    }

    .input-group input,
    .input-group select {
        flex: 1;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--body-bg);
        color: var(--text-color);
    }

    .quiz-container,
    .flashcard-container {
        min-height: 200px;
    }

    .quiz-question {
        margin-bottom: 20px;
        padding: 15px;
        background: var(--body-bg);
        border-radius: 8px;
    }

    .quiz-question h4 {
        margin-bottom: 15px;
    }

    .quiz-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .quiz-option {
        padding: 10px 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .quiz-option:hover {
        border-color: var(--primary-color);
    }

    .quiz-option.correct {
        background: #d1fae5;
        border-color: var(--success-color);
    }

    .quiz-option.incorrect {
        background: #fee2e2;
        border-color: var(--danger-color);
    }

    .flashcard {
        perspective: 1000px;
        height: 200px;
        cursor: pointer;
    }

    .flashcard-inner {
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        position: relative;
    }

    .flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg);
    }

    .flashcard-front,
    .flashcard-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
    }

    .flashcard-front {
        background: var(--primary-color);
        color: white;
    }

    .flashcard-back {
        background: var(--success-color);
        color: white;
        transform: rotateY(180deg);
    }

    .flashcard-nav {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 15px;
    }

    .loading {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--gray-color);
    }

    .loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 30px;"><i class="fas fa-robot" style="color: var(--primary-color);"></i> AI Study Assistant
</h1>

<div class="ai-container">
    <div class="ai-card">
        <h3><i class="fas fa-comments"></i> Ask Questions</h3>
        <div class="chat-box" id="chatBox"></div>
        <div class="input-group">
            <input type="text" id="questionInput" placeholder="Ask anything about your studies..."
                onkeypress="if(event.key==='Enter')askQuestion()">
            <button class="btn btn-primary" onclick="askQuestion()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="ai-card">
        <h3><i class="fas fa-question-circle"></i> Quiz Generator</h3>
        <div class="input-group" style="margin-bottom: 15px;">
            <input type="text" id="quizTopic" placeholder="Enter topic for quiz...">
            <select id="quizCount">
                <option value="3">3 Questions</option>
                <option value="5" selected>5 Questions</option>
                <option value="10">10 Questions</option>
            </select>
            <button class="btn btn-primary" onclick="generateQuiz()"><i class="fas fa-magic"></i></button>
        </div>
        <div class="quiz-container" id="quizContainer">
            <p style="color: var(--gray-color); text-align: center;">Enter a topic and generate a quiz!</p>
        </div>
    </div>

    <div class="ai-card" style="grid-column: span 2;">
        <h3><i class="fas fa-clone"></i> Flashcards</h3>
        <div class="input-group" style="margin-bottom: 20px;">
            <input type="text" id="flashcardTopic" placeholder="Enter topic for flashcards...">
            <button class="btn btn-primary" onclick="generateFlashcards()"><i class="fas fa-magic"></i>
                Generate</button>
        </div>
        <div class="flashcard-container" id="flashcardContainer">
            <p style="color: var(--gray-color); text-align: center;">Generate flashcards to study!</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let flashcards = [];
    let currentCard = 0;

    function addMessage(text, isUser) {
        const chatBox = document.getElementById('chatBox');
        const msg = document.createElement('div');
        msg.className = 'chat-message ' + (isUser ? 'user' : 'ai');
        msg.textContent = text;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function askQuestion() {
        const input = document.getElementById('questionInput');
        const question = input.value.trim();
        if (!question) return;

        addMessage(question, true);
        input.value = '';

        const chatBox = document.getElementById('chatBox');
        const loading = document.createElement('div');
        loading.className = 'loading';
        loading.innerHTML = '<i class="fas fa-spinner"></i> Thinking...';
        chatBox.appendChild(loading);

        try {
            const response = await fetch('/api/ai/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({ question })
            });
            const data = await response.json();
            loading.remove();
            addMessage(data.answer || data.error || 'Error', false);
        } catch (e) {
            loading.remove();
            addMessage('Error connecting to AI.', false);
        }
    }

    async function generateQuiz() {
        const topic = document.getElementById('quizTopic').value.trim();
        const count = document.getElementById('quizCount').value;
        if (!topic) return alert('Enter a topic!');

        const container = document.getElementById('quizContainer');
        container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Generating quiz...</div>';

        try {
            const response = await fetch('/api/ai/quiz', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({ topic, num_questions: parseInt(count) })
            });
            const data = await response.json();

            if (data.error) {
                container.innerHTML = '<p style="color: var(--danger-color);">' + data.error + '</p>';
                return;
            }

            container.innerHTML = '';
            (data.questions || []).forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'quiz-question';
                div.innerHTML = '<h4>Q' + (i + 1) + ': ' + q.question + '</h4><div class="quiz-options">' +
                    q.options.map((opt, j) => '<div class="quiz-option" onclick="checkAnswer(this,' + j + ',' + q.correct + ')">' + opt + '</div>').join('') +
                    '</div>';
                container.appendChild(div);
            });
        } catch (e) {
            container.innerHTML = '<p style="color: var(--danger-color);">Error generating quiz.</p>';
        }
    }

    function checkAnswer(el, selected, correct) {
        const options = el.parentElement.querySelectorAll('.quiz-option');
        options.forEach((opt, i) => {
            opt.onclick = null;
            if (i === correct) opt.classList.add('correct');
            else if (i === selected) opt.classList.add('incorrect');
        });
    }

    async function generateFlashcards() {
        const topic = document.getElementById('flashcardTopic').value.trim();
        if (!topic) return alert('Enter a topic!');

        const container = document.getElementById('flashcardContainer');
        container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Generating flashcards...</div>';

        try {
            const response = await fetch('/api/ai/flashcards', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({ topic })
            });
            const data = await response.json();

            if (data.error) {
                container.innerHTML = '<p style="color: var(--danger-color);">' + data.error + '</p>';
                return;
            }

            flashcards = data.flashcards || [];
            currentCard = 0;
            showFlashcard();
        } catch (e) {
            container.innerHTML = '<p style="color: var(--danger-color);">Error generating flashcards.</p>';
        }
    }

    function showFlashcard() {
        if (!flashcards.length) return;
        const container = document.getElementById('flashcardContainer');
        const card = flashcards[currentCard];
        container.innerHTML = `
            <div class="flashcard" onclick="this.classList.toggle('flipped')">
                <div class="flashcard-inner">
                    <div class="flashcard-front"><h3>${card.front}</h3></div>
                    <div class="flashcard-back"><h3>${card.back}</h3></div>
                </div>
            </div>
            <div class="flashcard-nav">
                <button class="btn btn-secondary" onclick="prevCard()"><i class="fas fa-chevron-left"></i> Previous</button>
                <span>${currentCard + 1} / ${flashcards.length}</span>
                <button class="btn btn-secondary" onclick="nextCard()">Next <i class="fas fa-chevron-right"></i></button>
            </div>
        `;
    }

    function prevCard() {
        currentCard = (currentCard - 1 + flashcards.length) % flashcards.length;
        showFlashcard();
    }

    function nextCard() {
        currentCard = (currentCard + 1) % flashcards.length;
        showFlashcard();
    }
</script>
{% endblock %}